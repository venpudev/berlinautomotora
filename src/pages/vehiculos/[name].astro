---
import Layout from '../../layouts/Layout.astro';
import { fetchAllVehicles, getCarsByIds } from '../../lib/fetchSliders';
import { formatNameForURL, extractYearFromName } from "../../helpers/stringHelpers";
import { formatPrice } from "../../helpers/formatHelpers";
import Hero from '@/components/hero-slider/Hero.tsx';

export const prerender = false;

const { name } = Astro.params;

if (!name) {
    return new Response(null, { status: 404, statusText: 'Página no encontrada' });
}

const allVehicles = await fetchAllVehicles();
const vehicleData = allVehicles.find(v => formatNameForURL(v.name) === name);

if (!vehicleData) {
    return new Response(null, { status: 404, statusText: 'Vehículo no encontrado' });
}

const response = await getCarsByIds({ id: String(vehicleData.id) });
const vehicle = response?.data;

if (!vehicle) {
    console.error(`Error: No se encontraron datos para el vehículo con ID: ${vehicleData.id}`);
    return new Response(null, { status: 404, statusText: 'Datos del vehículo no disponibles' });
}

const formattedPrice = formatPrice(vehicle.price);
const vehicleYear = extractYearFromName(vehicle.name);

let finalImages: { url: string; alt: string }[] = [];
if (vehicle.imageGallery && Array.isArray(vehicle.imageGallery) && vehicle.imageGallery.length > 0) {
    finalImages = vehicle.imageGallery
        .map(img => {
            const url = typeof img === 'string' ? img : (img as any)?.imageUrl || (img as any)?.url;
            return url ? { url, alt: `Imagen de ${vehicle.name}` } : null;
        })
        .filter((img): img is { url: string; alt: string } => img !== null && img.url);
} else if (vehicle.imageUrl) {
    finalImages = [{ url: vehicle.imageUrl, alt: `Imagen de ${vehicle.name}` }];
}

const ogImage = finalImages.length > 0 ? finalImages[0].url : '/default-og-image.jpg';
---

<Layout title={`${vehicle.name} - Berlin Automotora`} description={`${vehicle.name} - ${formattedPrice}`} image={ogImage}>
    <main class="min-h-screen bg-gray-50">
        <nav class="bg-white border-b border-gray-200 px-4 py-3 sticky top-[5rem] z-40">
            <div class="max-w-7xl mx-auto flex items-center text-sm text-gray-600">
                <a href="/" class="hover:text-red-600">Inicio</a>
                <span class="mx-2">/</span>
                <a href="/catalogo" class="hover:text-red-600">Vehículos</a>
                <span class="mx-2">/</span>
                <span class="text-gray-900 font-medium truncate">{vehicle.name}</span>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto py-8 px-4">
            <Hero client:load images={finalImages} />
        </div>

        <div class="bg-white border-t border-b border-gray-200 px-4 py-4">
            <div class="max-w-7xl mx-auto">
                <h1 class="text-xl md:text-2xl font-bold text-gray-900 mb-2">{vehicle.name}</h1>
                <div class="flex items-center space-x-3">
                    <span class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${vehicle.available ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                        {vehicle.available ? 'Disponible' : 'Vendido'}
                    </span>
                    <span class="text-2xl md:text-3xl font-bold text-gray-900">{formattedPrice}</span>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto mt-8 md:mt-12 px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-8 md:gap-12">

                <div class="md:col-span-2">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">
                        Características
                    </h2>
                    <div class="space-y-3 text-gray-700">
                        <div class="flex justify-between"><span><strong>Año:</strong></span> <span>{vehicleYear || 'N/A'}</span></div>
                        <div class="flex justify-between"><span><strong>Kilometraje:</strong></span> <span>{vehicle.miles?.toLocaleString('es-CL') || 'N/A'} km</span></div>
                        <div class="flex justify-between"><span><strong>Combustible:</strong></span> <span>{vehicle.fuelType || 'N/A'}</span></div>
                        <div class="flex justify-between"><span><strong>Transmisión:</strong></span> <span>{vehicle.transmission || 'N/A'}</span></div>
                        <div class="flex justify-between"><span><strong>Ubicación:</strong></span> <span>{vehicle.vendedor?.sucursal || 'No especificada'}</span></div>
                        <div class="flex justify-between"><span><strong>Estado:</strong></span> <span class=`font-semibold ${vehicle.available ? 'text-green-600' : 'text-red-600'}`}>{vehicle.available ? 'Disponible' : 'Vendido'}</span></div>
                    </div>
                </div>

                <div class="md:col-span-3">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">
                        Descripción
                    </h2>
                    <div class="prose max-w-none text-gray-700">
                        <p class="text-base leading-relaxed">
                            {vehicle.description || `Este ${vehicle.name} es una excelente opción para quienes buscan un vehículo confiable y con gran desempeño. Representa una oportunidad única en el mercado.`}
                        </p>
                    </div>
                </div>

            </div>
        </div>
        </main>
</Layout>