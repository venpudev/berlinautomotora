---
import Layout from '../../layouts/Layout.astro';
import { fetchAllVehicles, getCarsByIds } from '../../lib/fetchSliders';
import { formatNameForURL, extractYearFromName } from "../../helpers/stringHelpers";
import { formatPrice } from "../../helpers/formatHelpers";
import Hero from '@/components/hero-slider/Hero.tsx';

export const prerender = false;

const { name } = Astro.params;

if (!name) {
    return new Response(null, { status: 404, statusText: 'P√°gina no encontrada' });
}

const allVehicles = await fetchAllVehicles();
const vehicleData = allVehicles.find(v => formatNameForURL(v.name) === name);

if (!vehicleData) {
    return new Response(null, { status: 404, statusText: 'Veh√≠culo no encontrado' });
}

const response = await getCarsByIds({ id: String(vehicleData.id) });
const vehicle = response?.data;

if (!vehicle) {
    console.error(`Error: No se encontraron datos para el veh√≠culo con ID: ${vehicleData.id}`);
    return new Response(null, { status: 404, statusText: 'Datos del veh√≠culo no disponibles' });
}

const formattedPrice = formatPrice(vehicle.price);
const vehicleYear = extractYearFromName(vehicle.name);
const whatsappLink = `https://wa.me/56963361016?text=Hola,%20me%20interesa%20el%20veh√≠culo:%20${encodeURIComponent(vehicle.name)}`;

let finalImages: { url: string; alt: string }[] = [];
if (vehicle.imageGallery && Array.isArray(vehicle.imageGallery) && vehicle.imageGallery.length > 0) {
    finalImages = vehicle.imageGallery
        .map(img => {
            const url = typeof img === 'string' ? img : (img as any)?.imageUrl || (img as any)?.url;
            return url ? { url, alt: `Imagen de ${vehicle.name}` } : null;
        })
        .filter((img): img is { url: string; alt: string } => img !== null && img.url);
} else if (vehicle.imageUrl) {
    finalImages = [{ url: vehicle.imageUrl, alt: `Imagen de ${vehicle.name}` }];
}

const ogImage = finalImages.length > 0 ? finalImages[0].url : '/default-og-image.jpg';
---

<Layout title={`${vehicle.name} - Berlin Automotora`} description={`${vehicle.name} - ${formattedPrice}`} image={ogImage}>
    <main class="min-h-screen bg-gray-50 pt-32">
        
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-6 text-sm text-gray-600">
            <a href="/" class="hover:text-red-600">Inicio</a>
            <span class="mx-2">/</span>
            <a href="/catalogo" class="hover:text-red-600">Veh√≠culos</a>
            <span class="mx-2">/</span>
            <span class="text-gray-900 font-medium truncate">{vehicle.name}</span>
        </nav>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2 space-y-8">
                
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                    <Hero client:load images={finalImages} />
                </div>

                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4">Caracter√≠sticas</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-gray-700">
                        <div class="flex items-center space-x-3"><span class="text-red-500">üìÖ</span> <div><p class="text-sm text-gray-500">A√±o</p><p class="font-semibold">{vehicleYear || 'N/A'}</p></div></div>
                        <div class="flex items-center space-x-3"><span class="text-red-500">üöó</span> <div><p class="text-sm text-gray-500">Kilometraje</p><p class="font-semibold">{vehicle.miles?.toLocaleString('es-CL') || 'N/A'} km</p></div></div>
                        <div class="flex items-center space-x-3"><span class="text-red-500">‚õΩ</span> <div><p class="text-sm text-gray-500">Combustible</p><p class="font-semibold">{vehicle.fuelType || 'N/A'}</p></div></div>
                        <div class="flex items-center space-x-3"><span class="text-red-500">‚öôÔ∏è</span> <div><p class="text-sm text-gray-500">Transmisi√≥n</p><p class="font-semibold">{vehicle.transmission || 'N/A'}</p></div></div>
                        <div class="flex items-center space-x-3"><span class="text-red-500">üìç</span> <div><p class="text-sm text-gray-500">Ubicaci√≥n</p><p class="font-semibold">{vehicle.vendedor?.sucursal || 'No especificada'}</p></div></div>
                        <div class="flex items-center space-x-3"><span class="text-red-500">üè∑Ô∏è</span> <div><p class="text-sm text-gray-500">Estado</p><p class={`font-semibold ${vehicle.available ? 'text-green-600' : 'text-red-600'}`}>{vehicle.available ? 'Disponible' : 'Vendido'}</p></div></div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4">Descripci√≥n</h2>
                    <div class="prose max-w-none text-gray-700">
                        <p class="text-base leading-relaxed">
                            {vehicle.description || `Este ${vehicle.name} es una excelente opci√≥n para quienes buscan un veh√≠culo confiable y con gran desempe√±o. Representa una oportunidad √∫nica en el mercado.`}
                        </p>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1">
                <div class="sticky top-28 space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h1 class="text-2xl font-bold text-gray-900 mb-2">{vehicle.name}</h1>
                        <span class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium mb-4 ${vehicle.available ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                            {vehicle.available ? '‚úì Disponible' : '‚úó Vendido'}
                        </span>
                        <div class="mb-6">
                            <p class="text-3xl font-bold text-gray-900">{formattedPrice}</p>
                            <p class="text-sm text-gray-600">Precio final</p>
                        </div>
                        <a href={whatsappLink} target="_blank" rel="noopener noreferrer" class={`w-full font-bold py-3 px-4 rounded-lg transition-colors text-center block ${vehicle.available ? 'bg-green-600 hover:bg-green-700 text-white' : 'bg-gray-400 text-gray-600 cursor-not-allowed'}`}>
                            Contactar por WhatsApp
                        </a>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-lg font-bold mb-4">Medios de pago</h3>
                        <div class="space-y-3 text-gray-700">
                            <div class="flex items-center space-x-2"><span class="text-green-500">‚úì</span><span class="text-sm">Efectivo</span></div>
                            <div class="flex items-center space-x-2"><span class="text-green-500">‚úì</span><span class="text-sm">Transferencia bancaria</span></div>
                            <div class="flex items-center space-x-2"><span class="text-green-500">‚úì</span><span class="text-sm">Financiamiento disponible</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="h-16"></div>
    </main>
</Layout>

<style>
    /* Seleccionamos las im√°genes dentro de la galer√≠a */
    .swiper-slide img {
        /* Definimos una transici√≥n suave para las propiedades 'transform' y 'filter' */
        transition: transform 0.4s ease, filter 0.4s ease;
    }

    /* Al pasar el cursor sobre un slide, aplicamos el efecto a la imagen que contiene */
    .swiper-slide:hover img {
        /* Aumentamos ligeramente la escala para un efecto de zoom sutil */
        transform: scale(1.03);
        /* Aumentamos ligeramente el brillo para destacar la imagen */
        filter: brightness(1.05);
    }
</style>